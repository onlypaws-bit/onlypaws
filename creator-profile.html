<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Creator Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg1:#6B4EFF;
      --bg2:#8B6CFF;
      --text:#ffffff;
      --muted:rgba(255,255,255,.85);
      --stroke:rgba(255,255,255,.16);
      --card:rgba(0,0,0,.16);
      --shadow: rgba(0,0,0,.25);
      --btn:#ffffff;
      --btnText:#6B4EFF;
    }

    footer{
      margin-top:32px;
      padding-bottom:22px;
      color:rgba(255,255,255,.75);
      font-size:13px;
      text-align:center;
      line-height:1.5;
    }
    .smallLegal{display:inline-block;margin-top:6px;opacity:.85;font-size:12px;}

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1040px;margin:0 auto;padding:28px 18px 70px;}

    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:18px;}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:white;font-weight:900;letter-spacing:.2px;user-select:none;}
    .brandLogo{
      width:62px;height:62px;border-radius:14px;background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;overflow:hidden;
      transition: transform .18s ease;
    }
    .brand:hover .brandLogo{transform: translateY(-1px) scale(1.02);}
    .brandLogo img{width:46px;height:46px;object-fit:contain;}
    .navRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .navBtn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);color:white;text-decoration:none;font-weight:900;
      cursor:pointer; user-select:none; transition: transform .16s ease, background .16s ease, border-color .16s ease;
      font-size:13px; white-space:nowrap;
    }
    .navBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22);}
    .navBtn.primary{background:var(--btn);border:none;color:var(--btnText);box-shadow:0 14px 30px rgba(0,0,0,.20);}
    .navBtn.primary:hover{transform: translateY(-1px) scale(1.01);}
    .navBtn:active{transform: translateY(0px) scale(.99);}

    .panel{
      border-radius:22px;padding:22px;background:var(--card);
      border:1px solid var(--stroke);backdrop-filter: blur(10px);
      box-shadow:0 20px 45px var(--shadow);
    }

    .grid{display:grid;grid-template-columns: 1.25fr .75fr; gap:12px;}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:10px 14px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-size:13px;color:rgba(255,255,255,.85);
      white-space:nowrap;
    }

    h1{margin:10px 0 6px;font-size: clamp(2rem, 4vw, 2.6rem);line-height:1.05; letter-spacing:-0.6px;}
    .sub{margin:0;color:var(--muted);font-size:1.02rem;line-height:1.55;}

    .heroRow{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:10px;}
    .avatar{
      width:64px;height:64px;border-radius:20px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;font-size:22px;overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .meta b{display:block;font-size:1.05rem;}
    .meta span{display:block;color:rgba(255,255,255,.78);font-size:13px;margin-top:2px;white-space:pre-wrap;}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center;}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;
      background: var(--btn);color: var(--btnText);
      text-decoration:none;font-weight:900;border:none;cursor:pointer;
      box-shadow:0 14px 30px rgba(0,0,0,.22);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;}
    .ghost{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:900;cursor:pointer;
    }
    .ghost:disabled{opacity:.55;cursor:not-allowed;}
    .hint{color:rgba(255,255,255,.78);font-size:13px;line-height:1.4;margin-top:10px;white-space:pre-wrap;}

    /* Pets */
    .petsList{margin-top:12px;display:grid;gap:10px;}
    .petCard{
      border-radius:18px;padding:12px;background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      display:flex;gap:12px;align-items:center;
    }
    .petAvatar{
      width:46px;height:46px;border-radius:16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;font-size:18px;overflow:hidden;
    }
    .petAvatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .petCard b{display:block}
    .petCard span{display:block;color:rgba(255,255,255,.78);font-size:13px;margin-top:2px;}

    /* Posts */
    .postsHeader{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .postsHeader h2{margin:0;font-size:1.15rem;}
    .posts{margin-top:12px;display:grid;grid-template-columns:1fr;gap:12px;}

    .postCard{
      border-radius:22px;padding:18px;background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      position:relative;
      overflow:hidden;
    }
    .postCard:hover{transform: translateY(-1px);background: rgba(255,255,255,.12);border-color: rgba(255,255,255,.22);}
    .postTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.16);
      font-size:12px;font-weight:900;white-space:nowrap;
    }
    .postCard h3{margin:10px 0 8px;font-size:1.15rem;}
    .postCard p{margin:0;color:rgba(255,255,255,.86);line-height:1.55;white-space:pre-wrap;}

    .mediaWrap{
      margin-top:12px;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    .mediaWrap img,.mediaWrap video{width:100%;display:block;max-height:460px;object-fit:cover;}

    .isLocked .mediaWrap,
    .isLocked .postText{
      filter: blur(10px);
      opacity:.78;
      user-select:none;
      pointer-events:none;
    }
    .lockedOverlay{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      padding:16px;
      background: radial-gradient(600px 260px at 50% 40%, rgba(0,0,0,.35), rgba(0,0,0,.15) 55%, rgba(0,0,0,0) 75%);
    }
    .lockedBox{
      width:min(520px, 92%);
      border-radius:18px;
      padding:14px;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
    }
    .lockedBox b{display:block;font-size:14px;margin-bottom:6px;}
    .lockedBox .small{color:rgba(255,255,255,.82);font-size:13px;line-height:1.45;}
    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="nav">
      <a href="feed.html" class="brand">
        <div class="brandLogo"><img src="logo.png" alt="OnlyPaws logo"></div>
        <span>OnlyPaws</span>
      </a>
      <div class="navRight">
        <div class="pill" id="userPill">‚Ä¶</div>

        <a class="navBtn primary" id="navProfile" href="profile.html" style="display:none;">Profile</a>

        <!-- FAN dashboard -->
        <a class="navBtn" id="navFanDash" href="fan-dash.html" style="display:none;">Dashboard</a>

        <!-- CREATOR dashboard -->
        <a class="navBtn" id="navCreatorDash" href="creator-dash.html" style="display:none;">Dashboard</a>

        <button class="navBtn" id="navLogout" type="button" style="display:none;">Log out</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="pill">Creator</div>
        <h1 id="creatorName">Creator</h1>

        <div class="heroRow">
          <div class="avatar" id="creatorAvatar">üêæ</div>
          <div class="meta">
            <b id="creatorHandle">@username</b>
            <span id="creatorBio"></span>
          </div>
        </div>

        <div class="btnRow" id="actionRow">
          <button class="ghost" id="followBtn" type="button">Follow</button>
          <button class="btn" id="premiumBtn" type="button">Subscribe</button>
        </div>

        <div class="hint" id="creatorHint"></div>
      </div>

      <div class="panel">
        <div class="pill">Pets</div>
        <div class="petsList" id="petsList"></div>
        <div class="hint" id="petsHint">Loading‚Ä¶</div>
      </div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="postsHeader">
        <h2>Posts</h2>
        <div class="hint" style="margin-top:0;">FREE is visible ‚Ä¢ PREMIUM is locked (unless subscribed)</div>
      </div>
      <div class="posts" id="posts"></div>
      <div class="hint" id="postsHint">Loading‚Ä¶</div>
    </div>

  </div>

  <footer>
    ¬© 2026 OnlyPaws ‚Ä¢ Built with toe beans energy üêæ<br/>
    <span class="smallLegal">
      OnlyPaws is an independent digital platform. Features may evolve over time.
    </span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    function goIndex(){ window.location.replace("index.html"); }

    function show(el, yes){
      if(!el) return;
      el.style.display = yes ? "inline-flex" : "none";
    }

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getParams(){
      const p = new URLSearchParams(window.location.search);
      return {
        u: (p.get("u") || "").trim(),
        success: (p.get("success") || "").trim(),
        session_id: (p.get("session_id") || "").trim()
      };
    }

    function isUUID(v){
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v || "");
    }

    async function hydrateUserPill(){
      try{
        const pill = document.getElementById("userPill");
        if(!pill) return;

        const { data: sessData } = await onlypawsClient.auth.getSession();
        const session = sessData?.session;
        if(!session){
          pill.textContent = "Guest";
          return;
        }

        const uid = session.user.id;
        const email = session.user.email || "";

        const { data: prof } = await onlypawsClient
          .from("profiles")
          .select("username, display_name, role")
          .eq("user_id", uid)
          .maybeSingle();

        const uname = (prof?.username || "").trim();
        const dname = (prof?.display_name || "").trim();

        if(uname) pill.textContent = "@" + uname;
        else if(dname) pill.textContent = dname;
        else if(email) pill.textContent = email.split("@")[0];
        else pill.textContent = "User";
      }catch(e){}
    }

    async function hydrateNav(){
      const profileBtn = document.getElementById("navProfile");
      const fanDash = document.getElementById("navFanDash");
      const creatorDash = document.getElementById("navCreatorDash");
      const logoutBtn = document.getElementById("navLogout");

      show(profileBtn, true);
      show(logoutBtn, true);
      show(fanDash, false);
      show(creatorDash, false);

      try{
        const { data: u } = await onlypawsClient.auth.getUser();
        const userId = u?.user?.id;
        if(!userId) return;

        const { data: p } = await onlypawsClient
          .from("profiles")
          .select("role")
          .eq("user_id", userId)
          .maybeSingle();

        if(p?.role === "creator") show(creatorDash, true);
        else show(fanDash, true);
      }catch(e){}
    }

    function mediaBlock(p){
      if(!p.media_url) return "";
      const isVideo = p.media_type === "video";
      return `
        <div class="mediaWrap">
          ${isVideo
            ? `<video controls playsinline src="${esc(p.media_url)}"></video>`
            : `<img src="${esc(p.media_url)}" alt="Post media">`
          }
        </div>
      `;
    }

    function renderCreator(c){
      const name = c.display_name || c.username || "Creator";
      const uname = c.username || "username";
      const bio = c.bio || "";

      document.getElementById("creatorName").textContent = name;
      document.getElementById("creatorHandle").textContent = "@" + uname;
      document.getElementById("creatorBio").textContent = bio;

      const av = document.getElementById("creatorAvatar");
      const url = (c.avatar_url || "").trim();
      if(url){
        av.innerHTML = `<img src="${esc(url)}" alt="Creator avatar" loading="lazy" decoding="async" referrerpolicy="no-referrer">`;
      }else{
        av.textContent = "üêæ";
      }
    }

    function renderPets(list){
      const el = document.getElementById("petsList");
      if(!list || list.length === 0){
        el.innerHTML = "";
        return;
      }
      el.innerHTML = list.map(p => {
        const name = p.name || "Pet";
        const line = [p.species, p.breed].filter(Boolean).join(" ‚Ä¢ ");
        const av = (p.avatar_url || "").trim()
          ? `<img src="${esc(p.avatar_url)}" alt="Pet avatar" loading="lazy" decoding="async" referrerpolicy="no-referrer">`
          : "üêæ";

        return `
          <div class="petCard">
            <div class="petAvatar">${av}</div>
            <div>
              <b>${esc(name)}</b>
              <span>${esc(line || " ")}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    function lockedOverlayHtml(){
      return `
        <div class="lockedOverlay">
          <div class="lockedBox">
            <b>üîí Premium post</b>
            <div class="small">Subscribe to unlock all premium posts from this creator.</div>
            <div class="ctaRow">
              <button class="ghost" type="button" data-action="premium">Subscribe</button>
            </div>
          </div>
        </div>
      `;
    }

    // ‚úÖ Rules:
    // - private (is_public=false): only creator
    // - public free: everyone
    // - public premium: creator OR subscriber
    function renderPosts(list, creatorUsername, ent){
      const postsEl = document.getElementById("posts");

      if(!list || list.length === 0){
        postsEl.innerHTML = `
          <div class="postCard">
            <h3>No posts yet</h3>
            <p>This creator hasn‚Äôt published anything yet.</p>
          </div>
        `;
        return;
      }

      postsEl.innerHTML = list.map(p => {
        const who = creatorUsername ? `@${creatorUsername}` : "@creator";
        const title = p.title || "Post";
        const fullText = p.content || p.preview || "";
        const preview = p.preview || "Subscribe to unlock this post.";

        const isPremium = (p.is_paid === true);
        const isPrivate = (p.is_public === false);
        const isMine = (ent.isSelf === true);

        let canView = false;

        if(isPrivate){
          canView = isMine;
        }else if(!isPremium){
          canView = true;
        }else{
          canView = isMine || (ent.isSubscribed === true);
        }

        const badgeLabel = isPremium
          ? "üîí PREMIUM"
          : (isPrivate ? "üôà PRIVATE" : "üÜì FREE");

        return `
          <div class="postCard ${canView ? "" : "isLocked"}" data-postid="${esc(p.id)}">
            <div class="postTop">
              <div class="badge">${esc(who)}</div>
              <div class="badge">${badgeLabel}</div>
            </div>
            <h3>${esc(title)}</h3>
            ${mediaBlock(p)}
            <p class="postText">${esc(canView ? fullText : preview)}</p>
            ${canView ? "" : lockedOverlayHtml()}
          </div>
        `;
      }).join("");

      postsEl.querySelectorAll("[data-action='premium']").forEach(btn => {
        btn.addEventListener("click", () => {
          const pb = document.getElementById("premiumBtn");
          if(pb?.disabled){
            const hint = document.getElementById("creatorHint");
            // If the main button is disabled, show the same reason
            if(hint){
              hint.textContent = pb.title || "Subscriptions are not available right now.";
            }
            return;
          }
          pb.click();
        });
      });
    }

    async function loadCreatorByUsername(username){
      const { data, error } = await onlypawsClient
        .from("profiles")
        .select("user_id, username, display_name, bio, avatar_url, role, stripe_onboarding_status, charges_enabled")
        .eq("username", username)
        .maybeSingle();

      if(error) throw error;
      if(!data) throw new Error("Creator not found");
      if(data.role !== "creator") throw new Error("This user is not a creator");
      renderCreator(data);
      return data;
    }

    async function loadCreatorByUserId(userId){
      const { data, error } = await onlypawsClient
        .from("profiles")
        .select("user_id, username, display_name, bio, avatar_url, role, stripe_onboarding_status, charges_enabled")
        .eq("user_id", userId)
        .maybeSingle();

      if(error) throw error;
      if(!data) throw new Error("Creator not found");
      if(data.role !== "creator") throw new Error("This user is not a creator");
      renderCreator(data);
      return data;
    }

    async function loadPetsByOwner(ownerId){
      const hint = document.getElementById("petsHint");
      hint.textContent = "Loading‚Ä¶";

      const { data, error } = await onlypawsClient
        .from("pets")
        .select("id, name, species, breed, avatar_url")
        .eq("owner_id", ownerId)
        .order("created_at", { ascending: false });

      if(error) throw error;

      renderPets(data || []);
      hint.textContent = (data && data.length) ? "" : "No pets yet.";
    }

    async function loadPostsByCreatorId(creatorId){
      const hint = document.getElementById("postsHint");
      hint.textContent = "Loading‚Ä¶";

      const { data, error } = await onlypawsClient
        .from("posts")
        .select("id, creator_id, title, content, preview, media_url, media_type, is_paid, is_public, is_pinned, created_at")
        .eq("creator_id", creatorId)
        .order("is_pinned", { ascending: false })
        .order("created_at", { ascending: false })
        .limit(24);

      if(error) throw error;
      return data || [];
    }

    async function getFollowRowId(fanId, creatorId){
      const { data, error } = await onlypawsClient
        .from("followers")
        .select("id")
        .eq("creator_id", creatorId)
        .eq("fan_id", fanId)
        .maybeSingle();

      if(error) throw error;
      return data?.id || null;
    }

    async function isSubscribedToCreator(creatorId){
      const { data, error } = await onlypawsClient.rpc("is_subscribed_to", { p_creator_id: creatorId });
      if(error) throw error;
      return !!data;
    }

    function setupLogout(){
      const logoutBtn = document.getElementById("navLogout");
      if(!logoutBtn) return;
      logoutBtn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        logoutBtn.disabled = true;
        logoutBtn.textContent = "Logging out‚Ä¶";
        try { await onlypawsClient.auth.signOut(); } catch(e) {}
        goIndex();
      });
    }

    function setBtnBusy(btn, yes, txt){
      if(!btn) return;
      btn.disabled = !!yes;
      if(txt != null) btn.textContent = txt;
    }

    function goSubscribe(creatorId){
      if(!creatorId) return alert("‚ùå Missing creator id (can't open subscriptions-demo).");
      window.location.href = `subscriptions-demo.html?creator=${encodeURIComponent(creatorId)}`;
    }

    function setTopHint(msg){
      const el = document.getElementById("creatorHint");
      if(!el) return;
      el.textContent = msg || "";
    }

    async function boot(){
      setupLogout();

      const { data: sessData } = await onlypawsClient.auth.getSession();
      const session = sessData?.session;
      if(!session){ goIndex(); return; }

      await hydrateNav();
      await hydrateUserPill();

      const fanId = session.user.id;
      // Viewer role gate: creators cannot subscribe (for now)
      let viewerRole = "";
      try{
        const { data: vp } = await onlypawsClient
          .from("profiles")
          .select("role")
          .eq("user_id", fanId)
          .maybeSingle();
        viewerRole = (vp?.role || "").toString();
      }catch(e){}
      const viewerIsCreator = (viewerRole === "creator");
      const { u, success, session_id } = getParams();
      if(!u){ goIndex(); return; }

      const followBtn = document.getElementById("followBtn");
      const premiumBtn = document.getElementById("premiumBtn");
      const actionRow = document.getElementById("actionRow");

      function explainCreatorCantSubscribe(){
        setTopHint("‚è≥ Creator ‚Üí creator subscriptions are coming later. For now, creators can‚Äôt subscribe.");
      }
      function explainCreatorNotReady(){
        setTopHint("‚ö†Ô∏è This creator isn‚Äôt ready for subscriptions yet (Stripe setup incomplete).");
      }


      try{
        // ‚úÖ support both username and UUID in ?u=
        const creator = isUUID(u)
          ? await loadCreatorByUserId(u)
          : await loadCreatorByUsername(u);

        const creatorUsername = creator.username || "";
        const isSelf = (creator.user_id === fanId);
        actionRow.style.display = isSelf ? "none" : "flex";
        if(!isSelf && viewerIsCreator){
          // creators can still follow, but subscriptions are disabled for now
          explainCreatorCantSubscribe();
        }

        // Helpful post-checkout hint
        if(success === "1" || session_id){
          setTopHint("‚úÖ Payment received. Syncing subscription‚Ä¶ If it doesn't update immediately, refresh in a few seconds.");
        }else{
          setTopHint("");
        }

        // creator eligibility useful for tooltip only
        const creatorEligible = (creator.role === "creator"
          && creator.stripe_onboarding_status === "completed"
          && creator.charges_enabled === true);

        if(!creatorEligible){
          premiumBtn.title = "Creator not ready yet (Stripe setup). You can still open the subscription page.";
        }else{
          premiumBtn.title = "";
        }

        // Initial load
        let isSub = await isSubscribedToCreator(creator.user_id);

        // ‚úÖ after returning from Stripe, retry subscription check (webhook might be slightly delayed)
        if((success === "1" || session_id) && !isSub){
          // quick retries: 1.5s, 3s, 5s
          const waits = [1500, 3000, 5000];
          for(const w of waits){
            await new Promise(r => setTimeout(r, w));
            try{
              isSub = await isSubscribedToCreator(creator.user_id);
              if(isSub) break;
            }catch(e){}
          }
        }

        const [followRowId, posts] = await Promise.all([
          getFollowRowId(fanId, creator.user_id),
          loadPostsByCreatorId(creator.user_id),
        ]);

        let currentFollowId = followRowId;

        function setFollowUi(){
          followBtn.textContent = currentFollowId ? "Unfollow" : "Follow";
        }
        setFollowUi();

        followBtn.addEventListener("click", async () => {
          try{
            if(currentFollowId){
              setBtnBusy(followBtn, true, "Unfollowing‚Ä¶");
              const { error } = await onlypawsClient
                .from("followers")
                .delete()
                .eq("id", currentFollowId)
                .eq("fan_id", fanId);
              if(error) throw error;
              currentFollowId = null;
              setFollowUi();
            }else{
              setBtnBusy(followBtn, true, "Following‚Ä¶");
              const { data, error } = await onlypawsClient
                .from("followers")
                .insert({ creator_id: creator.user_id, fan_id: fanId })
                .select("id")
                .maybeSingle();
              if(error) throw error;
              currentFollowId = data?.id || null;
              setFollowUi();
            }
          }catch(e){
            alert(e?.message || String(e));
          }finally{
            setBtnBusy(followBtn, false);
          }
        });

                function setPremiumUi(){
          // Priority 1: viewer role gate
          if(viewerIsCreator){
            premiumBtn.textContent = "Coming soon";
            premiumBtn.disabled = true;
            premiumBtn.title = "Creators can‚Äôt subscribe yet.";
            return;
          }

          // Priority 2: target creator readiness (Stripe)
          if(!creatorEligible){
            premiumBtn.textContent = "Creator not ready";
            premiumBtn.disabled = true;
            premiumBtn.title = "Creator not ready yet (Stripe setup).";
            return;
          }

          // Normal state
          premiumBtn.textContent = isSub ? "Subscribed" : "Subscribe";
          premiumBtn.disabled = false;
          premiumBtn.title = "";
        }
        setPremiumUi();

        premiumBtn.addEventListener("click", () => {
          if(viewerIsCreator){
            explainCreatorCantSubscribe();
            return;
          }
          if(!creatorEligible){
            explainCreatorNotReady();
            return;
          }
          goSubscribe(creator.user_id);
        });

        await loadPetsByOwner(creator.user_id);

        renderPosts(posts, creatorUsername || (isUUID(u) ? creatorUsername : u), {
          isSelf,
          isSubscribed: !!isSub
        });

        document.getElementById("postsHint").textContent = posts.length ? "" : "No posts yet.";

        // If subscription became true, update hint + clean URL (optional)
        if(isSub && (success === "1" || session_id)){
          setTopHint("‚úÖ Subscribed! Premium posts are now unlocked.");
          // optional: remove noisy params but keep u
          const clean = new URL(window.location.href);
          clean.searchParams.delete("success");
          clean.searchParams.delete("session_id");
          window.history.replaceState({}, "", clean.toString());
        }

      }catch(e){
        document.getElementById("creatorHint").textContent = "‚ùå " + (e?.message || String(e));
        document.getElementById("petsHint").textContent = "";
        document.getElementById("postsHint").textContent = "";
      }
    }

    onlypawsClient.auth.onAuthStateChange((event) => {
      if(event === "SIGNED_OUT") goIndex();
    });

    boot();
  </script>
</body>
</html>
