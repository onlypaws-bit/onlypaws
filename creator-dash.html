<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OnlyPaws ‚Äî Creator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg1:#6B4EFF;
      --bg2:#8B6CFF;
      --text:#ffffff;
      --muted:rgba(255,255,255,.85);
      --stroke:rgba(255,255,255,.16);
      --card:rgba(0,0,0,.16);
      --btn:#ffffff;
      --btnText:#6B4EFF;
      --shadow: rgba(0,0,0,.25);
      --soft: rgba(255,255,255,.10);
      --soft2: rgba(255,255,255,.12);
      --danger: rgba(255,0,80,.18);
      --dangerBorder: rgba(255,0,80,.26);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(1000px 650px at 90% 30%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 90px;}

    /* NAV */
    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:18px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:white;font-weight:900;}
    .brandLogo{
      width:62px;height:62px;border-radius:14px;
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .brandLogo img{width:46px;height:46px;object-fit:contain;}
    .navRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      padding:8px 14px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-size:13px;color:rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .navBtn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:white;text-decoration:none;font-weight:900;
      cursor:pointer;font-size:13px;white-space:nowrap;
      transition:transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .navBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22);}
    .navBtn:active{transform: translateY(0px) scale(.99);}
    .navBtn.primary{
      background: var(--btn);
      color: var(--btnText);
      border-color: rgba(255,255,255,.22);
    }
    .navBtn.primary:hover{background: rgba(255,255,255,.95);}

    /* PANEL */
    .panel{
      border-radius:22px;padding:22px;
      background: var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 20px 45px var(--shadow);
    }
    h1{margin:0 0 6px;font-size: clamp(2rem, 4vw, 2.4rem);letter-spacing:-0.6px;}
    .sub{margin:0;color:var(--muted);line-height:1.55}

    /* TOP LAYOUT */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }
    .col{
      display:grid;
      gap:14px;
      align-content:start;
    }

    /* CARDS */
    .card{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:14px;
      height: fit-content;
    }
    .card h3{margin:0 0 8px;font-size:18px;letter-spacing:-0.2px}
    .hint{color:rgba(255,255,255,.82);font-size:13px;line-height:1.55}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btn, .ghost{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:12px;
      font-weight:900;cursor:pointer;text-decoration:none;
      border:1px solid rgba(255,255,255,.18);
      transition:transform .16s ease, background .16s ease, border-color .16s ease, opacity .16s ease;
      user-select:none;
      font-size:13px;
    }
    .btn{
      background: var(--btn);
      color: var(--btnText);
      border-color: rgba(255,255,255,.22);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.95);}
    .ghost{
      background: rgba(255,255,255,.10);
      color:white;
    }
    .ghost:hover{transform: translateY(-1px); background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.22);}
    .ghost.danger{
      background: var(--danger);
      border-color: var(--dangerBorder);
    }
    .ghost.danger:hover{background: rgba(255,0,80,.22);}

    .small{font-size:12px;color:rgba(255,255,255,.78);line-height:1.5;}
    .list{display:grid;gap:10px;margin-top:10px;}
    .rowCard{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      border-radius:16px;
      padding:12px 14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }

    .rowCard.clickable{
      cursor:pointer;
      transition: background .16s ease, transform .16s ease;
    }
    .rowCard.clickable:hover{
      background: rgba(255,255,255,.14);
      transform: translateY(-1px);
    }
    .rowCard b{display:block;margin-bottom:4px}
    .postMeta{min-width:0}
    .postActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .locked{
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
    }

    /* Section titles */
    .sectionTitle{
      margin-top:18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding-top:8px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:1.18rem;
      letter-spacing:-0.3px;
      line-height:1.2;
    }

    /* WALLET */
    .walletGrid{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:10px;margin-top:10px;}
    @media(max-width:520px){ .walletGrid{grid-template-columns:1fr;} }
    .kpi{
      padding:12px;border-radius:16px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
    }
    .kpi .k{font-size:12px;color:rgba(255,255,255,.80);font-weight:900;margin-bottom:6px}
    .kpi .v{font-size:22px;font-weight:900;letter-spacing:-0.4px}
    .kpi .s{font-size:12px;color:rgba(255,255,255,.78);margin-top:6px}

    /* Media */
    .mediaWrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.16);}
    .mediaWrap img,.mediaWrap video{display:block;width:100%;max-height:330px;object-fit:cover;background:rgba(0,0,0,.15);}

    .avatarMini,.petAvatarMini{
      width:34px;height:34px;border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      display:inline-flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .avatarMini img,.petAvatarMini img{width:100%;height:100%;object-fit:cover}
    .subLine{display:flex;align-items:center;gap:10px;}
    .petLine{display:flex;align-items:center;gap:10px;}

    footer{
      margin-top:32px;
      padding-bottom:22px;
      color:rgba(255,255,255,.75);
      font-size:13px;
      text-align:center;
      line-height:1.5;
    }
    .smallLegal{display:inline-block;margin-top:6px;opacity:.85;font-size:12px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="nav">
      <a href="feed.html" class="brand">
        <div class="brandLogo"><img src="logo.png" alt="OnlyPaws logo"></div>
        <span>OnlyPaws</span>
      </a>

      <div class="navRight">
        <div class="pill" id="whoPill">Dashboard</div>
        <a class="navBtn" id="profileBtn" href="profile.html" style="display:none;">Profile</a>
        <a class="navBtn" id="loginCreatorBtn" href="creators.html" style="display:none;">Log in</a>
        <a class="navBtn" id="logoutBtn" href="#" style="display:none;">Log out</a>
      </div>
    </div>

    <div class="panel">
      <h1>Creator dashboard</h1>
      <p class="sub">Manage creator tools: posts, audience, wallet and withdrawals.</p>

      <div class="grid">
        <!-- LEFT COLUMN: Status + Wallet -->
        <div class="col">
          <div class="card">
            <h3>Status</h3>
            <div class="hint" id="stateBox">Loading‚Ä¶</div>

            <div class="btnRow" style="margin-top:12px;">
              <a class="btn" id="createPostBtn" href="create-post.html" style="pointer-events:none;opacity:.6;">Create post</a>
              <a class="ghost" id="gotoProfileBtn" href="profile.html">View profile</a>
            </div>

            <div class="locked" style="margin-top:12px;">
              <b>Tip</b>
              <div class="hint">Post consistently to grow followers and convert them into subscribers üíú</div>
            </div>
          </div>

          <div class="card">
            <h3>Wallet</h3>
            <div class="hint" id="walletHint">Loading‚Ä¶</div>

            <div class="walletGrid">
              <div class="kpi">
                <div class="k">Available</div>
                <div class="v" id="walletAvailable">‚Äî</div>
                <div class="s">Available to withdraw.</div>
              </div>
              <div class="kpi">
                <div class="k">Pending</div>
                <div class="v" id="walletPending">‚Äî</div>
                <div class="s">Not withdrawable yet.</div>
              </div>
              <div class="kpi">
                <div class="k">Payouts</div>
                <div class="v" id="walletPayouts">‚Äî</div>
                <div class="s">Stripe payouts status.</div>
              </div>
            </div>

            <div id="walletMsg" class="locked" style="display:none;margin-top:10px;">
              <b>Wallet message</b>
              <div class="hint" id="walletMsgText"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: Withdraw -->
        <div class="col">
          <div class="card">
            <h3>Withdraw</h3>
            <div class="hint">
              Withdraw your available Stripe balance to your bank via Stripe. Minimum ‚Ç¨20.00.
            </div>

            <div class="btnRow" style="margin-top:10px;">
              <button class="btn" id="withdrawBtn" type="button" style="pointer-events:none;opacity:.6;">Request withdrawal</button>
              <a class="ghost" id="enablePayoutBtn" href="#" style="display:none;">Enable payouts</a>
              <button class="ghost" id="refreshWalletBtn" type="button">Refresh</button>
            </div>

            <div class="hint" id="withdrawHint" style="margin-top:10px;">‚Äî</div>

            <div class="locked" style="margin-top:12px;">
              <b>Heads up</b>
              <div class="hint">Withdraw triggers a Stripe payout on your connected account. If payouts are paused, enable them first.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PETS -->
      <div class="sectionTitle">
        <h2>Your pets</h2>
        <div class="hint" id="petsHint">Loading‚Ä¶</div>
      </div>
      <div class="btnRow" style="margin-top:8px;">
        <a class="ghost" href="pets.html">‚ûï Add / manage pets</a>
      </div>
      <div class="list" id="petsList"></div>

      <!-- SUBSCRIBERS -->
      <div class="sectionTitle">
        <h2>Your subscribers</h2>
        <div class="hint" id="subsHint">Loading‚Ä¶</div>
      </div>
      <div class="list" id="subsList"></div>

      <!-- FOLLOWERS -->
      <div class="sectionTitle">
        <h2>Your followers</h2>
        <div class="hint" id="followersHint">Loading‚Ä¶</div>
      </div>
      <div class="list" id="followersList"></div>

      <!-- POSTS -->
      <div class="sectionTitle">
        <h2>Your posts</h2>
        <div class="hint" id="myPostsHint">Loading‚Ä¶</div>
      </div>
      <div class="list" id="myPosts"></div>
    </div>

    <footer>
      ¬© 2026 OnlyPaws ‚Ä¢ Built with toe beans energy üêæ<br/>
      <span class="smallLegal">OnlyPaws is an independent digital platform. Features may evolve over time.</span>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="onlypawsClient.js"></script>
  <script>
    // ===== CONFIG =====
    const CREATOR_PLAN_URL = "https://buy.stripe.com/5kQbJ25UY5qegpM4kD5wI02";
    // Stripe Connect link is created by Supabase Edge Function: connect-update
    const MIN_WITHDRAW_CENTS = 2000;

    function goIndex(){ window.location.replace("index.html"); }

    const whoPill = document.getElementById("whoPill");
    const stateBox = document.getElementById("stateBox");
    const loginCreatorBtn = document.getElementById("loginCreatorBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const profileBtn = document.getElementById("profileBtn");
    const createPostBtn = document.getElementById("createPostBtn");
    const gotoProfileBtn = document.getElementById("gotoProfileBtn");
    const myPostsEl = document.getElementById("myPosts");
    const myPostsHint = document.getElementById("myPostsHint");
    const petsList = document.getElementById("petsList");
    const petsHint = document.getElementById("petsHint");
    const subsList = document.getElementById("subsList");
    const subsHint = document.getElementById("subsHint");
    const followersList = document.getElementById("followersList");
    const followersHint = document.getElementById("followersHint");

    // Wallet
    const walletHint = document.getElementById("walletHint");
    const walletAvailableEl = document.getElementById("walletAvailable");
    const walletPendingEl = document.getElementById("walletPending");
    const walletPayoutsEl = document.getElementById("walletPayouts");
    const walletMsg = document.getElementById("walletMsg");
    const walletMsgText = document.getElementById("walletMsgText");
    const withdrawBtn = document.getElementById("withdrawBtn");
    const enablePayoutBtn = document.getElementById("enablePayoutBtn");
    const refreshWalletBtn = document.getElementById("refreshWalletBtn");
    const withdrawHint = document.getElementById("withdrawHint");

    let __profileUserId = null;

    let __creatorUnlocked = false; // creator_plan active
    let __payoutEnabled = false;   // payouts_enabled active

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setState(title, text, extrasHtml){
      stateBox.innerHTML = `
        <b>${title}</b>
        <div class="hint">${(text || "").toString().replaceAll("\n","<br/>")}</div>
        ${extrasHtml || ""}
      `;
    }

    function enable(el, yes){
      if(!el) return;
      el.style.pointerEvents = yes ? "auto" : "none";
      el.style.opacity = yes ? "1" : ".6";
      if("disabled" in el) el.disabled = !yes;
    }

    function fmtEUR(cents){
      const n = Number(cents || 0);
      return "‚Ç¨" + (n / 100).toFixed(2);
    }

    function showWalletMsg(title, text){
      walletMsg.style.display = "block";
      walletMsg.querySelector("b").textContent = title;
      walletMsgText.textContent = text || "";
    }

    function hideWalletMsg(){
      walletMsg.style.display = "none";
      walletMsgText.textContent = "";
    }

    async function hasActiveCreatorPlan(userId){
      try{
        const { data, error } = await onlypawsClient
          .from("entitlements")
          .select("id")
          .eq("user_id", userId)
          .eq("key", "creator_plan")
          .eq("status", "active")
          .maybeSingle();
        if(error) return false;
        return !!data;
      }catch(e){ return false; }
    }

    async function hasPayoutsEnabled(userId){
      try{
        const { data, error } = await onlypawsClient
          .from("entitlements")
          .select("id")
          .eq("user_id", userId)
          .eq("key", "payouts_enabled")
          .eq("status", "active")
          .maybeSingle();
        if(error) return false;
        return !!data;
      }catch(e){ return false; }
    }

    async function fetchConnectStatus(){
      // Prefer Supabase Functions invoke (handles auth + avoids CORS headaches)
      const { data, error } = await onlypawsClient.functions.invoke("connect-status", { body: {} });
      if(error) throw error;
      return data;
    }

    // ===== Media preview =====
    function mediaBlock(p){
      if(!p?.media_url) return "";
      const isVideo = p.media_type === "video";
      const url = esc(p.media_url);
      if(isVideo){
        return `<div class="mediaWrap"><video controls playsinline src="${url}"></video></div>`;
      }
      return `<div class="mediaWrap"><img src="${url}" alt="Post media"></div>`;
    }

    function renderMyPosts(list){
      if(!list || list.length === 0){
        myPostsEl.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>No posts yet</b>
            <div class="hint">Create your first post to see it here.</div>
          </div>
        `;
        return;
      }
      myPostsEl.innerHTML = list.map(p => {
        const title = p.title || "Untitled";
        const isPaid = !!p.is_paid;
        const badge = isPaid ? "üîí PREMIUM" : "üÜì FREE";
        const vis = p.is_public ? "üåç PUBLIC" : "üôà PRIVATE";
        const date = p.created_at ? new Date(p.created_at).toLocaleString() : "";
        const preview = p.preview || (p.content ? String(p.content).slice(0, 90) : "");
        const id = p.id;
        return `
          <div class="rowCard" data-post-id="${esc(id)}">
            <div class="postMeta">
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:6px;">
                <span class="badge">${badge}</span>
                <span class="badge">${vis}</span>
                ${date ? `<span class="badge">${esc(date)}</span>` : ``}
              </div>
              <b>${esc(title)}</b>
              ${mediaBlock(p)}
              <div class="small" style="margin-top:8px;">${esc(preview || "")}</div>
            </div>
            <div class="postActions">
              <a class="ghost" href="create-post.html?edit=${encodeURIComponent(id)}">Edit</a>
              <button class="ghost danger" type="button" data-action="delete">Delete</button>
            </div>
          </div>
        `;
      }).join("");

      myPostsEl.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const row = btn.closest(".rowCard");
          const postId = row?.getAttribute("data-post-id");
          if(!postId) return;
          if(!confirm("Delete this post? This can‚Äôt be undone.")) return;

          btn.disabled = true;
          btn.textContent = "Deleting‚Ä¶";
          try{
            const { data: u } = await onlypawsClient.auth.getUser();
            const userId = u?.user?.id;
            const del = await onlypawsClient
              .from("posts")
              .delete()
              .eq("id", postId)
              .eq("creator_id", userId);
            if(del.error) throw del.error;
            row.remove();
            myPostsHint.textContent = "Deleted ‚úÖ";
            if(!myPostsEl.querySelector(".rowCard")){
              renderMyPosts([]);
              myPostsHint.textContent = "No posts yet.";
            }
          }catch(e){
            btn.disabled = false;
            btn.textContent = "Delete";
            alert("‚ùå Delete failed: " + (e?.message || String(e)));
          }
        });
      });
    }

    async function loadMyPosts(session){
      myPostsHint.textContent = "Loading‚Ä¶";
      myPostsEl.innerHTML = "";
      try{
        const { data, error } = await onlypawsClient
          .from("posts")
          .select("id, title, content, preview, media_url, media_type, is_paid, is_public, created_at")
          .eq("creator_id", session.user.id)
          .order("created_at", { ascending: false })
          .limit(30);
        if(error) throw error;
        renderMyPosts(data || []);
        myPostsHint.textContent = (data && data.length) ? "Loaded ‚úÖ" : "No posts yet.";
      }catch(e){
        myPostsHint.textContent = "Couldn‚Äôt load posts";
        myPostsEl.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>Posts list error</b>
            <div class="hint">${esc(e?.message || String(e))}</div>
          </div>
        `;
      }
    }

    function renderPets(list){
      if(!list || list.length === 0){
        petsList.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>No pets yet</b>
            <div class="hint">Add your first pet in Pets.</div>
          </div>
        `;
        return;
      }
      petsList.innerHTML = list.map(p => {
        const name = p.name || "Pet";
        const species = p.species ? `‚Ä¢ ${p.species}` : "";
        const breed = p.breed ? `‚Ä¢ ${p.breed}` : "";
        const age = (p.age_years != null) ? `‚Ä¢ ${p.age_years}y` : "";
        const bio = p.bio || "";
        const avatar = p.avatar_url
          ? `<img class="petAvatarMini" src="${esc(p.avatar_url)}" alt="pet avatar">`
          : `<div class="petAvatarMini">üêæ</div>`;
        return `
          <div class="rowCard">
            <div class="petMeta">
              <div class="petLine">
                ${avatar}
                <b style="margin:0;">${esc(name)} ${esc(species)} ${esc(breed)} ${esc(age)}</b>
              </div>
              <div class="small">${esc(bio)}</div>
            </div>
            <div class="postActions">
              <a class="ghost" href="pets.html">Manage</a>
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadPets(session){
      petsHint.textContent = "Loading‚Ä¶";
      petsList.innerHTML = "";
      try{
        const { data, error } = await onlypawsClient
          .from("pets")
          .select("id, name, species, breed, age_years, bio, avatar_url, created_at, owner_id")
          .eq("owner_id", session.user.id)
          .order("created_at", { ascending: false })
          .limit(30);
        if(error) throw error;
        renderPets(data || []);
        petsHint.textContent = (data && data.length) ? "Loaded ‚úÖ" : "No pets yet.";
      }catch(e){
        petsHint.textContent = "Couldn‚Äôt load pets";
        petsList.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>Pets list error</b>
            <div class="hint">${esc(e?.message || String(e))}</div>
          </div>
        `;
      }
    }
    
    function renderSubs(list){
      if(!list || list.length === 0){
        subsList.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>No subscribers yet</b>
            <div class="hint">Once paid subscriptions go live, they will show here.</div>
          </div>
        `;
        return;
      }

      const now = Date.now();

      // ‚úÖ Show canceled subs that are still valid until current_period_end
      const visible = (list || []).filter(s => {
        const status = String(s.status || "").toLowerCase();
        const cpe = s.current_period_end ? new Date(s.current_period_end).getTime() : 0;
        return (["active","trialing","past_due"].includes(status) || (cpe && cpe > now));
      });

      if(visible.length === 0){
        subsList.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>No active subscribers</b>
            <div class="hint">Subscriptions will appear here while access is valid.</div>
          </div>
        `;
        return;
      }

      subsList.innerHTML = visible.map(s => {
        const name = s.fan_display_name || s.fan_username || "Subscriber";
        const unameRaw = (s.fan_username || "").trim();
        const uname = unameRaw ? `@${unameRaw}` : "";

        const since = s.created_at ? new Date(s.created_at).toLocaleDateString() : "";
        const endDate = s.current_period_end ? new Date(s.current_period_end).toLocaleDateString() : "";

        const status = String(s.status || "").toLowerCase();
        const isActive = (s.is_active === true);
        // In this schema we don't have cancel_at_period_end. We infer it like fan-dash:
        // status=canceled + is_active=true => cancels at period end (still has access).
        const cancelsAtPeriodEnd = (status === "canceled" && isActive);

        let badgeText = "Active";
        let badgeIcon = "üíú";
        if(status === "trialing"){ badgeText = "Trial"; badgeIcon = "‚ú®"; }
        else if(status === "past_due"){ badgeText = "Past due"; badgeIcon = "‚ö†Ô∏è"; }
        else if(cancelsAtPeriodEnd && endDate){ badgeText = "Cancels at period end"; badgeIcon = "‚è≥"; }
        else if(!isActive){ badgeText = "Expired"; badgeIcon = "‚ùå"; }
        else if(status === "canceled"){ badgeText = "Canceled"; badgeIcon = "‚ùå"; }

        const avatar = s.fan_avatar_url
          ? `<img class="avatarMini" src="${esc(s.fan_avatar_url)}" alt="avatar">`
          : `<div class="avatarMini">üêæ</div>`;

        const renewOrUntil = endDate
          ? (cancelsAtPeriodEnd ? `Access until ${endDate}` : `Renews ${endDate}`)
          : "";

        const metaLine = [
          since ? `Subscribed: ${since}` : "",
          renewOrUntil
        ].filter(Boolean).join(" ‚Ä¢ ");

        const clickable = unameRaw ? "clickable" : "";
        return `
          <div class="rowCard ${clickable}" data-username="${esc(unameRaw)}">
            <div class="postMeta">
              <div class="subLine">
                ${avatar}
                <div style="display:flex;flex-direction:column;gap:2px;">
                  <b style="margin:0;">${esc(name)} ${uname ? `<span style="opacity:.85;font-weight:700;">${esc(uname)}</span>` : ""}</b>
                  <span class="small" style="opacity:.9;">${esc(metaLine)}</span>
                </div>
              </div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center">
              <span class="badge">${badgeIcon} ${esc(badgeText)}</span>
            </div>
          </div>
        `;
      }).join("");

      // ‚úÖ Row click ‚Üí fan profile (will build soon)
      subsList.querySelectorAll(".rowCard.clickable").forEach(row => {
        const username = (row.getAttribute("data-username") || "").trim();
        if(!username) return;
        row.addEventListener("click", () => {
          window.location.href = `fan-profile.html?u=${encodeURIComponent(username)}`;
        });
      });
    }

    function renderFollowers(list){
      if(!list || list.length === 0){
        followersList.innerHTML = `
          <div class="locked" style="margin-top:10px;">
            <b>No followers yet</b>
            <div class="hint">Free followers will show up here.</div>
          </div>
        `;
        return;
      }

      followersList.innerHTML = list.map(f => {
        const name = f.fan_display_name || f.fan_username || "Follower";
        const unameRaw = (f.fan_username || "").trim();
        const uname = unameRaw ? `@${unameRaw}` : "";
        const since = f.created_at ? new Date(f.created_at).toLocaleDateString() : "";

        const avatar = f.fan_avatar_url
          ? `<img class="avatarMini" src="${esc(f.fan_avatar_url)}" alt="avatar">`
          : `<div class="avatarMini">üêæ</div>`;

        const metaLine = since ? `Followed: ${since}` : "Followed";

        const clickable = unameRaw ? "clickable" : "";
        return `
          <div class="rowCard ${clickable}" data-username="${esc(unameRaw)}">
            <div class="postMeta">
              <div class="subLine">
                ${avatar}
                <div style="display:flex;flex-direction:column;gap:2px;">
                  <b style="margin:0;">${esc(name)} ${uname ? `<span style="opacity:.85;font-weight:700;">${esc(uname)}</span>` : ""}</b>
                  <span class="small" style="opacity:.9;">${esc(metaLine)}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // ‚úÖ Row click ‚Üí fan profile
      followersList.querySelectorAll(".rowCard.clickable").forEach(row => {
        const username = (row.getAttribute("data-username") || "").trim();
        if(!username) return;
        row.addEventListener("click", () => {
          window.location.href = `fan-profile.html?u=${encodeURIComponent(username)}`;
        });
      });
    }
    
    async function loadAudience(session){
      // Subscribers and followers are loaded independently (one failing must not block the other).
      subsHint.textContent = "Loading‚Ä¶";
      followersHint.textContent = "Loading‚Ä¶";
      subsList.innerHTML = "";
      followersList.innerHTML = "";

      // ---- Subscribers (from base table, avoid view filters) ----
      try{
        const { data: subsRows, error: se } = await onlypawsClient
          .from("creator_subscriptions")
          .select("fan_id,status,is_active,created_at,current_period_end,stripe_subscription_id")
          .eq("creator_id", session.user.id)
          .order("created_at", { ascending: false })
          .limit(200);

        if(se) throw se;

        const fanIds = Array.from(new Set((subsRows || []).map(r => r.fan_id).filter(Boolean)));
        const pMap = new Map();

        if(fanIds.length){
          const { data: profs, error: pe } = await onlypawsClient
            .from("profiles")
            .select("user_id, username, display_name, avatar_url")
            .in("user_id", fanIds);

          if(pe) throw pe;

          for(const p of (profs || [])) pMap.set(p.user_id, p);
        }

        const subs = (subsRows || []).map(r => {
          const p = pMap.get(r.fan_id) || {};
          return {
            ...r,
            fan_username: p.username || null,
            fan_display_name: p.display_name || null,
            fan_avatar_url: p.avatar_url || null,
          };
        });

        renderSubs(subs || []);
        subsHint.textContent = (subs && subs.length) ? "Loaded ‚úÖ" : "No subscribers yet.";
      }catch(e){
        const msg = esc(e?.message || String(e));
        subsHint.textContent = "Couldn‚Äôt load subscribers";
        subsList.innerHTML = `<div class="locked" style="margin-top:10px;"><b>Subscribers error</b><div class="hint">${msg}</div></div>`;
      }

      // ---- Followers (view) ----
      try{
        const { data: foll, error: fe } = await onlypawsClient
          .from("v_followers_creator")
          .select("*")
          .eq("creator_id", session.user.id)
          .order("created_at", { ascending: false })
          .limit(200);

        if(fe) throw fe;

        renderFollowers(foll || []);
        followersHint.textContent = (foll && foll.length) ? "Loaded ‚úÖ" : "No followers yet.";
      }catch(e){
        const msg = esc(e?.message || String(e));
        followersHint.textContent = "Couldn‚Äôt load followers";
        followersList.innerHTML = `<div class="locked" style="margin-top:10px;"><b>Followers error</b><div class="hint">${msg}</div></div>`;
      }
    }


    async function loadSubscribers(session){ return loadAudience(session); }

    // ‚úÖ Stripe balance (connected) + eligibility
    async function loadWallet(){
      walletHint.textContent = "Loading‚Ä¶";
      hideWalletMsg();

      walletAvailableEl.textContent = "‚Äî";
      walletPendingEl.textContent = "‚Äî";
      walletPayoutsEl.textContent = "‚Äî";
      withdrawHint.textContent = "‚Äî";

      enable(withdrawBtn, false);
      if(enablePayoutBtn) enablePayoutBtn.style.display = "none";

      try{
        const { data, error } = await onlypawsClient.functions.invoke("creator-balance", { body: {} });
        if(error) throw error;

        const available = Number(data?.available_cents || 0);
        const pending = Number(data?.pending_cents || 0);

        walletAvailableEl.textContent = fmtEUR(available);
        walletPendingEl.textContent = fmtEUR(pending);
        walletPayoutsEl.textContent = __payoutEnabled ? "YES" : "NO";

        if(!__creatorUnlocked){
          enable(withdrawBtn, false);
          withdrawHint.textContent = "Creator Plan required to withdraw.";
          walletHint.textContent = "Loaded ‚úÖ";
          return;
        }

        if(!__payoutEnabled){
          enable(withdrawBtn, false);
          if(enablePayoutBtn) enablePayoutBtn.style.display = "inline-flex";
          withdrawHint.textContent = "Enable payouts to withdraw.";
          walletHint.textContent = "Loaded ‚úÖ";
          return;
        }

        if(enablePayoutBtn) enablePayoutBtn.style.display = "none";

        if(available < MIN_WITHDRAW_CENTS){
          enable(withdrawBtn, false);
          withdrawHint.textContent = "Minimum withdrawal is ‚Ç¨20.00.";
          walletHint.textContent = "Loaded ‚úÖ";
          return;
        }

        enable(withdrawBtn, true);
        withdrawHint.textContent = "Ready ‚úÖ You can withdraw " + fmtEUR(available);
        walletHint.textContent = "Loaded ‚úÖ";

      }catch(e){
        walletHint.textContent = "Couldn‚Äôt load wallet";
        showWalletMsg("Wallet error", e?.message || String(e));
      }
    }

    // ‚úÖ Opzione 2: payout diretto Stripe sul connected account
    async function requestWithdrawal(){
      if(!__creatorUnlocked) return alert("Creator Plan required to withdraw.");
      if(!__payoutEnabled) return alert("Enable payouts first.");

      withdrawBtn.disabled = true;
      withdrawBtn.textContent = "Withdrawing‚Ä¶";
      try{
        const { data, error } = await onlypawsClient.functions.invoke("withdraw-now", { body: {} });
        if(error) throw error;

        withdrawHint.textContent = "Withdrawal requested ‚úÖ";
        alert("‚úÖ Withdrawal requested.");
        await loadWallet();
      }catch(e){
        const msg = e?.message || String(e);
        withdrawHint.textContent = "Withdrawal failed: " + msg;
        alert("‚ùå Withdrawal failed: " + msg);
      }finally{
        withdrawBtn.disabled = false;
        withdrawBtn.textContent = "Request withdrawal";
      }
    }

    // ‚úÖ Stripe Connect: open payouts onboarding/update flow (server creates Account Link)
    async function openPayoutSetup(){
      try{
        if(!enablePayoutBtn) return;

        enablePayoutBtn.textContent = "Opening Stripe‚Ä¶";
        enablePayoutBtn.style.pointerEvents = "none";
        enablePayoutBtn.style.opacity = ".75";

        const returnUrl = window.location.origin + "/payouts-setup.html?done=1";
        const refreshUrl = window.location.origin + "/payouts-setup.html?retry=1";

        const { data, error } = await onlypawsClient.functions.invoke("connect-update", {
          body: { return_url: returnUrl, refresh_url: refreshUrl }
        });

        if(error){
          const ctxBody = error?.context?.body;
          const extra =
            ctxBody
              ? (typeof ctxBody === "string" ? ctxBody : JSON.stringify(ctxBody))
              : "";
          throw new Error((error.message || "Edge Function error") + (extra ? " ‚Äî " + extra : ""));
        }

        if(!data?.url) throw new Error("Missing Stripe URL");
        window.location.href = data.url;

      }catch(e){
        const msgText = e?.message || String(e);
        withdrawHint.textContent = "Payout setup failed: " + msgText;
        alert("‚ùå Payout setup failed: " + msgText);
      }finally{
        if(enablePayoutBtn){
          enablePayoutBtn.textContent = "Enable payouts";
          enablePayoutBtn.style.pointerEvents = "auto";
          enablePayoutBtn.style.opacity = "1";
        }
      }
    }

    // ===== MAIN LOAD =====
    async function load(){
      if(typeof onlypawsClient === "undefined"){
        setState("‚ùå onlypawsClient missing", "Check onlypawsClient.js path and script order.");
        return;
      }

      enable(gotoProfileBtn, true);

      if(refreshWalletBtn && refreshWalletBtn.dataset.bound !== "1"){
        refreshWalletBtn.dataset.bound = "1";
        refreshWalletBtn.addEventListener("click", loadWallet);
      }
      if(withdrawBtn && withdrawBtn.dataset.bound !== "1"){
        withdrawBtn.dataset.bound = "1";
        withdrawBtn.addEventListener("click", requestWithdrawal);
      }
      if(enablePayoutBtn && enablePayoutBtn.dataset.bound !== "1"){
        enablePayoutBtn.dataset.bound = "1";
        enablePayoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          openPayoutSetup();
        });
      }

      const { data: sessData } = await onlypawsClient.auth.getSession();
      const session = sessData?.session;

      loginCreatorBtn.style.display = session ? "none" : "inline-flex";
      logoutBtn.style.display = session ? "inline-flex" : "none";
      profileBtn.style.display = session ? "inline-flex" : "none";

      __creatorUnlocked = false;
      __payoutEnabled = false;
      if(enablePayoutBtn) enablePayoutBtn.style.display = "none";

      if(!session){
        whoPill.textContent = "Dashboard";
        enable(createPostBtn, false);
        setState("Not logged in", "Log in as a creator to access dashboard tools.");
        myPostsHint.textContent = "Log in to see your posts.";
        myPostsEl.innerHTML = "";
        petsHint.textContent = "Log in to see pets.";
        petsList.innerHTML = "";
        subsHint.textContent = "Log in to see subscribers.";
        subsList.innerHTML = "";
        followersHint.textContent = "Log in to see followers.";
        followersList.innerHTML = "";
        walletHint.textContent = "Log in to see wallet.";
        enable(withdrawBtn, false);
        return;
      }

      const email = session.user?.email || "creator";
      whoPill.textContent = email;

      const { data: prof, error: pe } = await onlypawsClient
        .from("profiles")
        .select("user_id, username, display_name, role")
        .eq("user_id", session.user.id)
        .maybeSingle();

      if(pe){
        enable(createPostBtn, false);
        setState("Profile error", pe.message);
        __profileUserId = null;
        await loadWallet();
        await loadPets(session);
        await loadSubscribers(session);
        await loadMyPosts(session);
        return;
      }

      __profileUserId = prof?.user_id || session.user.id;

      const role = prof?.role || "fan";
      const username = prof?.username;
      const handle = username ? `@${username}` : (prof?.display_name || email);
      whoPill.textContent = handle;

      if(username){
        createPostBtn.href = `create-post.html?u=${encodeURIComponent(username)}`;
        gotoProfileBtn.href = `profile.html?u=${encodeURIComponent(username)}`;
      }else{
        createPostBtn.href = "create-post.html";
        gotoProfileBtn.href = "profile.html";
      }

      if(role !== "creator"){
        enable(createPostBtn, false);
        setState("üö´ Not a creator account", "Your profile role is not set to creator.");
        await loadWallet();
        await loadPets(session);
        await loadSubscribers(session);
        await loadMyPosts(session);
        return;
      }

      const active = await hasActiveCreatorPlan(session.user.id);
      __creatorUnlocked = !!active;

      if(!active){
        enable(createPostBtn, false);
        const qp = new URLSearchParams(window.location.search);
        const cameFromStripe = (
          qp.has("session_id") || qp.has("success") || qp.has("checkout") ||
          qp.has("payment_intent") || qp.has("redirect_status")
        );

        const extras = `
          <div class="btnRow" style="margin-top:12px;">
            ${
              cameFromStripe
                ? `<button class="navBtn primary" type="button" disabled style="opacity:.65;cursor:not-allowed;">Creator Plan processing‚Ä¶</button>`
                : `<a class="navBtn primary" href="${CREATOR_PLAN_URL}" target="_blank" rel="noopener">Unlock Creator Access ‚Äî ‚Ç¨10/month</a>`
            }
            <button class="navBtn" type="button" id="refreshBtn">Refresh</button>
          </div>
          ${
            cameFromStripe
              ? `<div class="hint" style="margin-top:10px;">‚úÖ Payment started ‚Äî waiting for Stripe confirmation. Then press Refresh.</div>`
              : ``
          }
        `;

        setState(
          "üîí Creator tools locked",
          cameFromStripe
            ? "Thanks! Your payment is processing. Creator Plan stays disabled until our server receives confirmation from Stripe."
            : "Your creator account is ready, but the Creator Plan is not active yet (or the dashboard can‚Äôt read it).",
          extras
        );

        setTimeout(() => {
          const refreshBtn = document.getElementById("refreshBtn");
          if(refreshBtn) refreshBtn.addEventListener("click", () => window.location.reload());
        }, 0);

        await loadWallet();
        await loadPets(session);
        await loadSubscribers(session);
        await loadMyPosts(session);
        return;
      }

      try{
        const cs = await fetchConnectStatus();
        console.log("connect-status", cs);
        __payoutEnabled = !!cs?.payouts_enabled;
      }catch(e){
        console.warn("connect-status failed, falling back to entitlements:", e);
        __payoutEnabled = await hasPayoutsEnabled(session.user.id);
      }

      enable(createPostBtn, true);
      setState("‚úÖ Creator unlocked", "Plan active. You can create posts and use creator tools.");

      await loadWallet();
      await loadPets(session);
      await loadSubscribers(session);
      await loadMyPosts(session);
    }

    (function setupLogoutOnce(){
      if(!logoutBtn) return;
      if(logoutBtn.dataset.bound === "1") return;
      logoutBtn.dataset.bound = "1";
      logoutBtn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        logoutBtn.disabled = true;
        logoutBtn.textContent = "Logging out‚Ä¶";
        try { await onlypawsClient.auth.signOut(); } catch(e) {}
        goIndex();
      });
    })();

    load();
  </script>
</body>
</html>
